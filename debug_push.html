<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Debugger</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            word-break: break-all;
        }

        .box {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>

<body>
    <h1>üïµÔ∏è Push Debugger v2</h1>

    <div class="box">
        <h3>1. Status</h3>
        <p>Permission: <strong id="permStatus">checking...</strong></p>
        <p>Token: <span id="tokenDisplay">loading...</span></p>
        <button onclick="forceGetToken()">Step 1: Get Token</button>
    </div>

    <div class="box">
        <h3>2. Database Check</h3>
        <p>Is Token in DB? <strong id="dbStatus">...</strong></p>
        <button onclick="checkDB()">Step 2: Check Firestore</button>
        <button onclick="saveToDB()">Force Save to DB</button>
    </div>

    <div class="box">
        <h3>3. Test Delivery</h3>
        <p>Send a test notification to THIS device only.</p>
        <button onclick="sendTestPush()">Step 3: Send Test Push</button>
    </div>

    <div id="logs" class="box"
        style="background: #333; color: #0f0; font-family: monospace; height: 200px; overflow: auto;">
        Logs will appear here...
    </div>

    <script>
        // Log Helper
        function log(msg) {
            const logs = document.getElementById('logs');
            logs.innerHTML += `<div>> ${msg}</div>`;
            console.log(msg);
            logs.scrollTop = logs.scrollHeight;
        }

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAPn7Wa7Cw0_NeiGNuCgUlJcIsJjNFTk84",
            authDomain: "astro-quiz-push-2026.firebaseapp.com",
            projectId: "astro-quiz-push-2026",
            storageBucket: "astro-quiz-push-2026.firebasestorage.app",
            messagingSenderId: "659060108550",
            appId: "1:659060108550:web:81bfa17f16d75453580287"
        };
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        const db = firebase.firestore();

        let currentToken = null;

        // 1. Get Token
        async function forceGetToken() {
            log("Checking permissions...");
            document.getElementById('permStatus').innerText = Notification.permission;

            if (Notification.permission !== 'granted') {
                log("Requesting permission...");
                const p = await Notification.requestPermission();
                document.getElementById('permStatus').innerText = p;
                if (p !== 'granted') return log("Permission Denied!");
            }

            try {
                log("Registering Service Worker...");
                const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                log("Service Worker Registered.");

                log("Fetching Token...");
                const token = await messaging.getToken({ serviceWorkerRegistration: reg });
                if (token) {
                    currentToken = token;
                    document.getElementById('tokenDisplay').innerText = token.substring(0, 20) + "...";
                    log("Token Retrieved: " + token.substring(0, 20) + "...");
                } else {
                    log("No Instance ID token available.");
                }
            } catch (e) {
                log("Error getting token: " + e.message);
            }
        }

        // 2. Check DB
        async function checkDB() {
            if (!currentToken) return log("Please Get Token first.");
            try {
                log("Checking Firestore for token...");
                const doc = await db.collection('subscribers').doc(currentToken).get();
                if (doc.exists) {
                    document.getElementById('dbStatus').innerText = "‚úÖ FOUND";
                    document.getElementById('dbStatus').className = "success";
                    log("Token exists in Database.");
                } else {
                    document.getElementById('dbStatus').innerText = "‚ùå MISSING";
                    document.getElementById('dbStatus').className = "error";
                    log("Token NOT in Database.");
                }
            } catch (e) {
                log("DB Error: " + e.message);
                document.getElementById('dbStatus').innerText = "ERROR";
            }
        }

        async function saveToDB() {
            if (!currentToken) return log("No token.");
            try {
                await db.collection('subscribers').doc(currentToken).set({
                    token: currentToken,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'debugger'
                });
                log("‚úÖ Saved to Firestore successfully!");
                checkDB();
            } catch (e) {
                log("‚ùå Save Failed: " + e.message);
            }
        }

        // 3. Send Test Push (Call Backend)
        async function sendTestPush() {
            if (!currentToken) return log("No token.");
            log("Requesting Test Push from Backend...");

            try {
                const payload = {
                    title: 'Debug Test',
                    body: 'This is a test from the debugger.',
                    target_token: currentToken
                };

                const response = await fetch('api/send_push.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const txt = await response.text();
                log("Backend Response: " + txt);
            } catch (e) {
                log("Fetch Error: " + e.message);
            }
        }

        // Foreground Handler
        messaging.onMessage((payload) => {
            log("üîî FOREGROUND MESSAGE RECEIVED!");
            log("Title: " + payload.notification.title);
            alert("SUCCESS! Notification Received:\n" + payload.notification.title);
        });

    </script>
</body>

</html>